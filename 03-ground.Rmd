```{r vis_startup,echo=FALSE,message=FALSE,warning=FALSE}
library(lidR)
library(ggplot2)
```

# Groud classification

Classification of ground points is an important step in processing point cloud data. Distinguishing between ground and non-ground points allows to not only create a continous model of terrain elevation (or Digital Terrain Model, DTM), but is also crucial for some of the following processing steps. 

Two ground classification algorithms are currently implemented in `lidR`: Progressive Morphological Filter (`pmf()`) and Cloth Simulation Function (`csf()`). 




## PMF

The implementation of PMF algorithm in `lidR` is based on the method described in [Zhang et al. (2003) ](https://ieeexplore.ieee.org/document/1202973). In this approach an initial raster surface is created based on the lowest point within each pixel. Morphological opening is then performed using a user defined window size. The resulting raster surface is compared with the initial one and all differences that exceed user-defined threshold value are removed. The operation is then repeated several times, resulting in further filtering of the initial raster surface. The remaining pixels represent lowest points and are used to classify them as "ground".

The `pmf()` function requires to input parameters to be defined: `ws` (sequence of window sizes), and `th` (sequence of threshold heights). More experienced user may experiment with these parameters to achieve best classification accuracy, however `lidR` contains `util_makeZhangParam()` function that includes the default paramter values described in [Zhang et al. (2003) ](https://ieeexplore.ieee.org/document/1202973).

Below we present a basic example of using the `pmf()` algorithm to classify ground points. In this example we will use the `Topography.laz` dataset that is included in the `lidR` package. We start by loading the point cloud dataset:

```{r}
LASfile <- system.file("extdata", "Topography.laz", package="lidR")
las <- readLAS(LASfile, select = "xyzrn")

```

We then use the `lasground()` function to generated a DTM. In the first run we will run the function with a single window size and single threshold value.
```{r}
las_1 <- lasground(las, algorithm = pmf(ws = 5, th = 3))
```

We can now visualize the result:

```{r, eval=F}
plot(las_1, color = "Classification") #doesn't work with rmarkdown
```

To better illustrate the classification results we can generate and plot a crossection of the point cloud. To do this we will use the `lasclipTransect()` function as follows:

```{r}

p1 <- c(273450, 5274500) #beginning of the crossection
p2 <- c(273550, 5274500) #end of the crossection

tr_las_1 <- lasclipTransect(las_1, p1, p2, width = 5)
```

To visualize the crossection we plot the `Z` coordinate on the y-axis.
```{r}
ggplot(tr_las_1@data, aes(X,Z, color=factor(Classification))) + 
  geom_point() + 
  coord_equal() + theme(legend.position = "bottom")
```

We can see that although the classification worked, there are multiple points above terrain that are classified as "2" ("ground"). This clearly indicates that additional filtering steps are needed and that both `ws` and `th` paramters should be adjusted.

```{r}
ws <- seq(3,12, 3)
th <- seq(0.1, 1.5, length.out = length(ws))

las_2 <- lasground(las, algorithm = pmf(ws = ws, th = th))
```

After this adjustement the classification result changed, and points in the canopy are no longer classified as "ground".
```{r}
tr_las_2 <- lasclipTransect(las_2, p1, p2, width = 5)

ggplot(tr_las_2@data, aes(X,Z, color=factor(Classification))) + 
  geom_point() + 
  coord_equal() + theme(legend.position = "bottom")
```












