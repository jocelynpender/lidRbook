```{r,echo=FALSE,message=FALSE,warning=FALSE}
r3dDefaults = rgl::r3dDefaults
m = structure(c(0.921, -0.146, 0.362, 0, 0.386, 0.482, -0.787, 0, 
-0.06, 0.864, 0.5, 0, 0, 0, 0, 1), .Dim = c(4L, 4L))
rgl::setupKnitr()
r3dDefaults$FOV = 50
r3dDefaults$userMatrix = m
r3dDefaults$zoom = 0.75

library(lidR)
```

# Reading, Plotting, Querying & Validating {-#my-section}

## Reading lidar data using `readLAS` {-#my-section}

The first step to working with lidar data in R is understanding how to read a file using the `lidR`package. Here we demonstrate how to read the `Megaplot.laz` file using the `readLAS` function.

```{r}
#Read Megaplot.laz from within the lidar package
LASfile <- system.file("extdata", "Megaplot.laz", package="lidR")
#Read a .las file from a local disc
# `LAS`file <- readLAS("PathToYourFile.las")
#Read `LAS`file
las <- readLAS(LASfile)
#print the content summary of the las file
print(las)
```

### Parameter `select` {-#my-section}

To save memory, `readLAS` can take an optional parameter `select` which enables the user to selectively load the data of interest. For example, one can choose to only load only the `X Y Z` fields.

```r
las <-  readLAS(LASfile, select = "xyz")
# load XYZ and intensity data only
#las = readLAS(las, select = "xyzi")
#load all data except for intensity and user data
#las = readLAS(las, select = "* -i -u") # Negation works too
```

### Parameter `filter` {-#my-section}

While `select` enables the user to select "columns" (or attributes) while reading files, `filter` allows selection of "rows" (or points) while reading. Removing data at reading time that is superfluous for your purposes saves memory and decreases computation time.

```{r}
# filter LASfile for first returns only
las <-  readLAS(LASfile, filter = "-keep_first")
#filter LASfile for first returns only & drop all points <= 5 & >= 50
#las <-  readLAS(LASfile, select = "xyzi", filter = "-keep_first -drop_z_below 5 -drop_z_above 50")
```

## Plotting {-#my-section}

The `lidR` package employs a built in `PointCloudViewer`.

```{r, rgl = TRUE}
# plot las object using default settings
plot(las, size = 3)
```

The `color` parameter expects the name of the attribute you want to use to colorize points. Default is `Z`. The background colour of the viewer can also be changed by inputing a color into the `bg` parameter.

```{r, rgl = TRUE}
# Plot las object by return number, make the background grey, and display XYZ axis
plot(las, color = "ScanAngleRank", bg = "white", axis = T, size = 3)
# If your file contains RGB data the string "RGB" is supported:
# plot(las, color ="RGB", size = 3)
```

The `trim` parameter enables trimming of values when outliers break the color palette range. For example, Intensity often contains large outliers. The palette range would be too large and most of the values will be considered as "very low", so everything will appear in the same color.

```{r, rgl = TRUE}
#Plot color by intensity, trim the palette to 50 colors, and display background as white
plot(las, color = "Intensity", trim = 50, bg = "white", size = 3)
```

## Basic structure of `LAS` objects {-#my-section}

For the purposes of this review we will briefly go over the primary contents of a `LAS` object. 

A `LAS` object is composed of four slots: 

* `@data`  - a `data.table`containing the `X,Y,Z` coordinates and attributes for all points within a file
* `@header` - a `LAS` file header that summarizes key file details
* `@proj4string` - Object that stores the coordinate reference system (`CRS`) of the las file
* `@bbox` - a matrix object that stores the `XY` bounding box of the point cloud inherited from the `Spatial` from the `sp` package

For the purposes of this section we will focus on the contents of the `@data` slot.For a thorough description of the other three `LAS` object slots see section ____. 

To query the contents of the `@data` slot we use the following code:

```{r}
# print the first 6 rows (points) of the lidar data
head(las@data)

```

This provides us with a subset of the `data.table` summarizing the `X,Y,Z` coordinates of each point, as well as other key information such as `ReturnNumber` and `Intensity`.

## Validating lidar data {-#my-section}

An important first step in lidar data processing is ensuring that your data is complete and valid. Users commonly report bugs about their point cloud being invalid. This is why we introduced the `lascheck` function to perform a deep inspection of `LAS` objects. This function checks if a `LAS` object meets specifications and whether it is invalid for processing. 

A simple example that happens fairly often is that a `LAS` file contains duplicate points. This may lead to trees being detected twice, to invalid metrics, or to errors in DTM generation, and so onâ€¦ Always make sure to run the `lascheck` function before digging deep into your data.

```{r}
lascheck(las)
```

